<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>予約ダッシュボード</title>
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <h2>
    📊 予約ダッシュボード
    <span id="todayDate" style="font-size:16px; margin-left:15px; color:#555;"></span>
  </h2>

  <!-- 現在のフィルタ条件表示 -->
  <div id="currentFilterInfo" class="filter-info">
    表示条件：全店舗｜全期間｜受取日 全て
  </div>

  <!-- フィルタバー -->
  <div class="filter-bar">
    <!-- 店舗フィルタ -->
    <div class="store-filter">
      <label for="storeFilter">店舗で絞り込み:</label>
      <select id="storeFilter">
        <option value="">全店舗</option>
        <option value="ポケット店">ポケット店</option>
        <option value="アップティ店">アップティ店</option>
        <option value="キララ店">キララ店</option>
      </select>
    </div>

    <!-- プリセット期間ボタン -->
    <div class="preset-buttons">
      <span>期間プリセット:</span>
      <button type="button" data-preset="tomorrow">明日</button>
      <button type="button" data-preset="today">今日</button>
      <button type="button" data-preset="week">今週</button>
      <button type="button" data-preset="month">今月</button>
      <button type="button" data-preset="all" class="active">全期間</button>
    </div>

    <!-- 受取日範囲 -->
    <div class="date-range">
      <label for="pickupStart">受取日（開始）:</label>
      <input type="date" id="pickupStart">

      <label for="pickupEnd">受取日（終了）:</label>
      <input type="date" id="pickupEnd">

      <button type="button" id="applyDateRange">適用</button>
    </div>
  </div>

  <!-- 売上合計 -->
  <div id="salesSummary" class="summary">売上合計: 0円</div>

  <!-- 予約テーブル -->
  <table>
    <thead>
      <tr>
        <th>予約番号</th>
        <th>名前</th>
        <th>電話番号</th>
        <th>受取店舗</th>
        <th>受取日</th>
        <th>受取時間</th>
        <th>商品</th>
        <th>合計金額</th>
        <th>備考</th>
        <th>受信日時</th>
      </tr>
    </thead>
    <tbody id="reservation-list">
      <tr><td colspan="10">読み込み中...</td></tr>
    </tbody>
  </table>

  <!-- モーダル -->
  <div id="loadingModal" class="modal">
    <div class="modal-content">
      <div class="spinner"></div>
      <p>読み込み中です...</p>
    </div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbydiE4I-Q6t58xEbnbxEvlJMeHsqKooDvGu0AXxIlq9Iuz5uVn5gWqpc7aqrOGwTixuwg/exec";
    let currentPreset = "all";

    // 今日の日付表示
    function updateTodayDate() {
      const now = new Date();
      const weekdays = ["日","月","火","水","木","金","土"];
      const formatted = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日（${weekdays[now.getDay()]}）`;
      document.getElementById("todayDate").textContent = formatted;
    }
    updateTodayDate();

    // モーダル表示制御
    function showModal() { document.getElementById("loadingModal").style.display = "flex"; }
    function hideModal() { document.getElementById("loadingModal").style.display = "none"; }

    // データ取得
    async function loadReservations() {
      showModal();
      try {
        const res = await fetch(GAS_URL + "?action=getReservations");
        const data = await res.json();
        renderTable(data);
      } catch (err) {
        document.getElementById("reservation-list").innerHTML =
          "<tr><td colspan='10'>エラー: " + err + "</td></tr>";
      } finally { hideModal(); }
    }

    // テーブル描画
    function renderTable(data) {
      const storeFilter = document.getElementById("storeFilter").value;
      const startDateInput = document.getElementById("pickupStart").value;
      const endDateInput = document.getElementById("pickupEnd").value;
      const list = document.getElementById("reservation-list");
      list.innerHTML = "";

      let filtered = data.filter(r => !storeFilter || r.store === storeFilter);

      const today = new Date();
      const startOfWeek = new Date(today); startOfWeek.setDate(today.getDate() - today.getDay() + 1);
      const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      const endOfMonth = new Date(today.getFullYear(), today.getMonth()+1, 0);

      filtered = filtered.filter(r => {
        const created = new Date(r.createdAt);
        switch(currentPreset){
          case "tomorrow": const tomorrow = new Date(today); tomorrow.setDate(today.getDate()+1); return created.toDateString() === tomorrow.toDateString();
          case "today": return created.toDateString() === today.toDateString();
          case "week": return created >= startOfWeek && created <= today;
          case "month": return created >= startOfMonth && created <= endOfMonth;
          default: return true;
        }
      });

      // 受取日範囲
      if(startDateInput || endDateInput){
        const startDate = startDateInput ? new Date(startDateInput) : null;
        const endDate = endDateInput ? new Date(endDateInput) : null;
        filtered = filtered.filter(r => {
          const pickupDate = new Date(r.pickupDateFormatted);
          if(startDate && pickupDate < startDate) return false;
          if(endDate && pickupDate > endDate) return false;
          return true;
        });
      }

      // フィルタ条件表示
      const presetLabel = {"tomorrow":"明日","today":"今日","week":"今週","month":"今月","all":"全期間"}[currentPreset];
      const storeLabel = storeFilter || "全店舗";
      const dateLabel = (startDateInput || endDateInput) ? `${startDateInput||"指定なし"}〜${endDateInput||"指定なし"}` : "全て";
      document.getElementById("currentFilterInfo").innerHTML =
        `🔎 表示条件：<strong>${storeLabel}</strong>｜<strong>${presetLabel}</strong>｜受取日 <strong>${dateLabel}</strong>`;

      filtered.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
      let totalSales = 0;

      if(filtered.length===0){
        list.innerHTML="<tr><td colspan='10'>該当する予約はありません</td></tr>";
        document.getElementById("salesSummary").textContent="売上合計: 0円";
        return;
      }

      filtered.forEach(r=>{
        totalSales+=Number(r.total);
        const tr = document.createElement("tr");
        tr.innerHTML=`
          <td>${r.id}</td>
          <td>${r.name}様</td>
          <td>${r.phone}</td>
          <td>${r.store}</td>
          <td>${r.pickupDateFormatted}</td>
          <td>${r.pickupTimeFormatted}</td>
          <td>${(r.products||"").replace(/\n/g,"<br>")}</td>
          <td>${Number(r.total).toLocaleString()}円</td>
          <td>${r.memo||""}</td>
          <td>${r.createdAt}</td>
        `;
        list.appendChild(tr);
      });

      document.getElementById("salesSummary").textContent="売上合計: "+totalSales.toLocaleString()+"円";
    }

    // イベント
    document.getElementById("storeFilter").addEventListener("change",loadReservations);
    document.getElementById("applyDateRange").addEventListener("click",loadReservations);
    document.querySelectorAll(".preset-buttons button").forEach(btn=>{
      btn.addEventListener("click", e=>{
        document.querySelectorAll(".preset-buttons button").forEach(b=>b.classList.remove("active"));
        e.target.classList.add("active");
        currentPreset = e.target.dataset.preset;
        loadReservations();
      });
    });

    loadReservations();
  </script>
</body>
</html>
