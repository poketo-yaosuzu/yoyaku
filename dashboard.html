<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>äºˆç´„ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <h2>
    ğŸ“Š äºˆç´„ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
    <span id="todayDate" style="font-size:16px; margin-left:15px; color:#555;"></span>
  </h2>

  <div id="currentFilterInfo" class="filter-info">
    è¡¨ç¤ºæ¡ä»¶ï¼šå…¨åº—èˆ—ï½œå…¨æœŸé–“ï½œå—å–æ—¥ å…¨ã¦
  </div>

  <div class="filter-bar">
    <div class="store-filter">
      <label for="storeFilter">åº—èˆ—ã§çµã‚Šè¾¼ã¿:</label>
      <select id="storeFilter">
        <option value="">å…¨åº—èˆ—</option>
        <option value="ãƒã‚±ãƒƒãƒˆåº—">ãƒã‚±ãƒƒãƒˆåº—</option>
        <option value="ã‚¢ãƒƒãƒ—ãƒ†ã‚£åº—">ã‚¢ãƒƒãƒ—ãƒ†ã‚£åº—</option>
        <option value="ã‚­ãƒ©ãƒ©åº—">ã‚­ãƒ©ãƒ©åº—</option>
      </select>
    </div>

    <div class="preset-buttons">
      <span>æœŸé–“ãƒ—ãƒªã‚»ãƒƒãƒˆ:</span>
      <button type="button" data-preset="tomorrow">æ˜æ—¥</button>
      <button type="button" data-preset="today">ä»Šæ—¥</button>
      <button type="button" data-preset="week">ä»Šé€±</button>
      <button type="button" data-preset="month">ä»Šæœˆ</button>
      <button type="button" data-preset="all" class="active">å…¨æœŸé–“</button>
    </div>

    <div class="date-range">
      <label for="pickupStart">å—å–æ—¥ï¼ˆé–‹å§‹ï¼‰:</label>
      <input type="date" id="pickupStart">
      <label for="pickupEnd">å—å–æ—¥ï¼ˆçµ‚äº†ï¼‰:</label>
      <input type="date" id="pickupEnd">
      <button type="button" id="applyDateRange">é©ç”¨</button>
    </div>
  </div>

  <div id="salesSummary" class="summary">å£²ä¸Šåˆè¨ˆ: 0å††</div>

  <table>
    <thead>
      <tr>
        <th>äºˆç´„ç•ªå·</th>
        <th>åå‰</th>
        <th>é›»è©±ç•ªå·</th>
        <th>å—å–åº—èˆ—</th>
        <th>å—å–æ—¥</th>
        <th>å—å–æ™‚é–“</th>
        <th>å•†å“</th>
        <th>åˆè¨ˆé‡‘é¡</th>
        <th>å‚™è€ƒ</th>
        <th>å—ä¿¡æ—¥æ™‚</th>
      </tr>
    </thead>
    <tbody id="reservation-list">
      <tr><td colspan='10'>èª­ã¿è¾¼ã¿ä¸­...</td></tr>
    </tbody>
  </table>

  <div id="loadingModal" class="modal">
    <div class="modal-content">
      <div class="spinner"></div>
      <p>èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>
    </div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbydiE4I-Q6t58xEbnbxEvlJMeHsqKooDvGu0AXxIlq9Iuz5uVn5gWqpc7aqrOGwTixuwg/exec";
    let currentPreset = "all";

    function updateTodayDate() {
      const now = new Date();
      const weekdays = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
      document.getElementById("todayDate").textContent =
        `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ï¼ˆ${weekdays[now.getDay()]}ï¼‰`;
    }
    updateTodayDate();

    const showModal = () => document.getElementById("loadingModal").style.display = "flex";
    const hideModal = () => document.getElementById("loadingModal").style.display = "none";

    // æ—¥æœ¬èªæ—¥ä»˜ â†’ Dateå‹
    function parseJapaneseDate(str) {
      if (!str) return null;
      const m = str.match(/(\d{4})å¹´(\d{2})æœˆ(\d{2})æ—¥/);
      if (!m) return null;
      return new Date(`${m[1]}-${m[2]}-${m[3]}`);
    }

    function parseDateStart(dateStr) {
      if (!dateStr) return null;
      const d = new Date(dateStr.replace(/-/g, "/"));
      d.setHours(0,0,0,0);
      return d;
    }
    function parseDateEnd(dateStr) {
      if (!dateStr) return null;
      const d = new Date(dateStr.replace(/-/g, "/"));
      d.setHours(23,59,59,999);
      return d;
    }

    function getPickupRangeForPreset(preset) {
      const today = new Date();
      const startToday = new Date(today); startToday.setHours(0,0,0,0);
      const endToday = new Date(today); endToday.setHours(23,59,59,999);

      switch(preset) {
        case "tomorrow": {
          const t = new Date(startToday);
          t.setDate(t.getDate()+1);
          return { start: parseDateStart(t.toISOString().slice(0,10)), end: parseDateEnd(t.toISOString().slice(0,10)) };
        }
        case "today": return { start: startToday, end: endToday };
        case "week": {
          const day = today.getDay();
          const diffToMon = (day===0)? -6 : 1-day;
          const start = new Date(today); start.setDate(today.getDate()+diffToMon); start.setHours(0,0,0,0);
          const end = new Date(start); end.setDate(start.getDate()+6); end.setHours(23,59,59,999);
          return { start, end };
        }
        case "month": {
          const start = new Date(today.getFullYear(), today.getMonth(), 1); start.setHours(0,0,0,0);
          const end = new Date(today.getFullYear(), today.getMonth()+1, 0); end.setHours(23,59,59,999);
          return { start, end };
        }
        default: return { start:null, end:null };
      }
    }

    // å—å–æ™‚é–“ã‚’ hhæ™‚mmåˆ† å½¢å¼ã«å¤‰æ›
    function formatPickupTime(timeStr){
      if(!timeStr) return "";
      const [h,m] = timeStr.split(":");
      return `${Number(h)}æ™‚${m.padStart(2,"0")}åˆ†`;
    }

    function renderTable(data){
      const storeFilter = document.getElementById("storeFilter").value;
      const startDateInput = document.getElementById("pickupStart").value;
      const endDateInput = document.getElementById("pickupEnd").value;
      const list = document.getElementById("reservation-list");
      list.innerHTML = "";

      let filtered = data.filter(r=>!storeFilter || r.store===storeFilter);
      filtered = filtered.filter(r=>r.pickupDateFormatted && parseJapaneseDate(r.pickupDateFormatted));

      let rangeStart = null, rangeEnd = null;
      if(startDateInput || endDateInput){
        rangeStart = parseDateStart(startDateInput);
        rangeEnd = parseDateEnd(endDateInput);
      }else{
        const presetRange = getPickupRangeForPreset(currentPreset);
        rangeStart = presetRange.start; rangeEnd = presetRange.end;
      }

      if(rangeStart || rangeEnd){
        filtered = filtered.filter(r=>{
          const pickupDate = parseJapaneseDate(r.pickupDateFormatted);
          if(!pickupDate) return false;
          pickupDate.setHours(12);
          if(rangeStart && pickupDate<rangeStart) return false;
          if(rangeEnd && pickupDate>rangeEnd) return false;
          return true;
        });
      }

      // ğŸ”¹ å—å–æ—¥æ˜‡é †ï¼ˆæ—©ã„é †ï¼‰
      filtered.sort((a,b)=>parseJapaneseDate(a.pickupDateFormatted)-parseJapaneseDate(b.pickupDateFormatted));

      const presetLabelMap = { "tomorrow":"æ˜æ—¥", "today":"ä»Šæ—¥", "week":"ä»Šé€±", "month":"ä»Šæœˆ", "all":"å…¨æœŸé–“" };
      const presetLabel = presetLabelMap[currentPreset] || "å…¨æœŸé–“";
      const storeLabel = storeFilter || "å…¨åº—èˆ—";
      const dateLabel = (startDateInput||endDateInput)
        ? `${startDateInput||"æŒ‡å®šãªã—"}ã€œ${endDateInput||"æŒ‡å®šãªã—"}`
        : (rangeStart||rangeEnd)
          ? `${rangeStart?rangeStart.toISOString().slice(0,10):"æŒ‡å®šãªã—"}ã€œ${rangeEnd?rangeEnd.toISOString().slice(0,10):"æŒ‡å®šãªã—"}`
          : "å…¨ã¦";

      document.getElementById("currentFilterInfo").innerHTML =
        `ğŸ” è¡¨ç¤ºæ¡ä»¶ï¼š<strong>${storeLabel}</strong>ï½œ<strong>${presetLabel}</strong>ï½œå—å–æ—¥ <strong>${dateLabel}</strong>`;

      let totalSales=0;
      if(filtered.length===0){
        list.innerHTML="<tr><td colspan='10'>è©²å½“ã™ã‚‹äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>";
        document.getElementById("salesSummary").textContent="å£²ä¸Šåˆè¨ˆ: 0å††";
        return;
      }

      filtered.forEach(r=>{
        totalSales+=Number(r.total||0);
        const tr = document.createElement("tr");
        tr.innerHTML=`
          <td>${r.id||""}</td>
          <td>${r.name?r.name+"æ§˜":""}</td>
          <td>${r.phone||""}</td>
          <td>${r.store||""}</td>
          <td>${r.pickupDateFormatted||""}</td>
          <td>${formatPickupTime(r.pickupTime)||""}</td>
          <td>${(r.products||"").replace(/\n/g,"<br>")}</td>
          <td>${Number(r.total||0).toLocaleString()}å††</td>
          <td>${r.memo||""}</td>
          <td>${r.createdAt||""}</td>
        `;
        list.appendChild(tr);
      });
      document.getElementById("salesSummary").textContent="å£²ä¸Šåˆè¨ˆ: "+totalSales.toLocaleString()+"å††";
    }

    async function loadReservations(){
      showModal();
      try{
        const res=await fetch(GAS_URL+"?action=getReservations");
        const data=await res.json();
        renderTable(data);
      }catch(err){
        document.getElementById("reservation-list").innerHTML="<tr><td colspan='10'>ã‚¨ãƒ©ãƒ¼:"+err+"</td></tr>";
      }finally{hideModal();}
    }

    document.getElementById("storeFilter").addEventListener("change",loadReservations);
    document.getElementById("applyDateRange").addEventListener("click",loadReservations);
    document.querySelectorAll(".preset-buttons button").forEach(btn=>{
      btn.addEventListener("click",e=>{
        document.querySelectorAll(".preset-buttons button").forEach(b=>b.classList.remove("active"));
        e.target.classList.add("active");
        currentPreset=e.target.dataset.preset;
        // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’æŠ¼ã—ãŸã‚‰æ—¥ä»˜ç¯„å›²ã«è‡ªå‹•ã‚»ãƒƒãƒˆ
        const range=getPickupRangeForPreset(currentPreset);
        document.getElementById("pickupStart").value=range.start ? range.start.toISOString().slice(0,10) : "";
        document.getElementById("pickupEnd").value=range.end ? range.end.toISOString().slice(0,10) : "";
        loadReservations();
      });
    });

    loadReservations();
  </script>
</body>
</html>
