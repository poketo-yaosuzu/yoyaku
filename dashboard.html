<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>äºˆç´„ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <h2>
    ğŸ“Š äºˆç´„ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
    <span id="todayDate" style="font-size:16px; margin-left:15px; color:#555;"></span>
  </h2>

  <!-- ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶è¡¨ç¤º -->
  <div id="currentFilterInfo" class="filter-info">
    è¡¨ç¤ºæ¡ä»¶ï¼šå…¨åº—èˆ—ï½œå…¨æœŸé–“ï½œå—å–æ—¥ å…¨ã¦
  </div>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒãƒ¼ -->
  <div class="filter-bar">
    <!-- åº—èˆ—ãƒ•ã‚£ãƒ«ã‚¿ -->
    <div class="store-filter">
      <label for="storeFilter">åº—èˆ—ã§çµã‚Šè¾¼ã¿:</label>
      <select id="storeFilter">
        <option value="">å…¨åº—èˆ—</option>
        <option value="ãƒã‚±ãƒƒãƒˆåº—">ãƒã‚±ãƒƒãƒˆåº—</option>
        <option value="ã‚¢ãƒƒãƒ—ãƒ†ã‚£åº—">ã‚¢ãƒƒãƒ—ãƒ†ã‚£åº—</option>
        <option value="ã‚­ãƒ©ãƒ©åº—">ã‚­ãƒ©ãƒ©åº—</option>
      </select>
    </div>

    <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆæœŸé–“ãƒœã‚¿ãƒ³ -->
    <div class="preset-buttons">
      <span>æœŸé–“ãƒ—ãƒªã‚»ãƒƒãƒˆ:</span>
      <button type="button" data-preset="tomorrow">æ˜æ—¥</button>
      <button type="button" data-preset="today">ä»Šæ—¥</button>
      <button type="button" data-preset="week">ä»Šé€±</button>
      <button type="button" data-preset="month">ä»Šæœˆ</button>
      <button type="button" data-preset="all" class="active">å…¨æœŸé–“</button>
    </div>

    <!-- å—å–æ—¥ç¯„å›² -->
    <div class="date-range">
      <label for="pickupStart">å—å–æ—¥ï¼ˆé–‹å§‹ï¼‰:</label>
      <input type="date" id="pickupStart">

      <label for="pickupEnd">å—å–æ—¥ï¼ˆçµ‚äº†ï¼‰:</label>
      <input type="date" id="pickupEnd">

      <button type="button" id="applyDateRange">é©ç”¨</button>
    </div>
  </div>

  <!-- å£²ä¸Šåˆè¨ˆ -->
  <div id="salesSummary" class="summary">å£²ä¸Šåˆè¨ˆ: 0å††</div>

  <!-- äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <table>
    <thead>
      <tr>
        <th>äºˆç´„ç•ªå·</th>
        <th>åå‰</th>
        <th>é›»è©±ç•ªå·</th>
        <th>å—å–åº—èˆ—</th>
        <th>å—å–æ—¥</th>
        <th>å—å–æ™‚é–“</th>
        <th>å•†å“</th>
        <th>åˆè¨ˆé‡‘é¡</th>
        <th>å‚™è€ƒ</th>
        <th>å—ä¿¡æ—¥æ™‚</th>
      </tr>
    </thead>
    <tbody id="reservation-list">
      <tr><td colspan="10">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
    </tbody>
  </table>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="loadingModal" class="modal">
    <div class="modal-content">
      <div class="spinner"></div>
      <p>èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>
    </div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbydiE4I-Q6t58xEbnbxEvlJMeHsqKooDvGu0AXxIlq9Iuz5uVn5gWqpc7aqrOGwTixuwg/exec";
    let currentPreset = "all";

    // ä»Šæ—¥ã®æ—¥ä»˜è¡¨ç¤º
    function updateTodayDate() {
      const now = new Date();
      const weekdays = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
      const formatted = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ï¼ˆ${weekdays[now.getDay()]}ï¼‰`;
      document.getElementById("todayDate").textContent = formatted;
    }
    updateTodayDate();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºåˆ¶å¾¡
    function showModal() { document.getElementById("loadingModal").style.display = "flex"; }
    function hideModal() { document.getElementById("loadingModal").style.display = "none"; }

    // ãƒ‡ãƒ¼ã‚¿å–å¾—
    async function loadReservations() {
      showModal();
      try {
        const res = await fetch(GAS_URL + "?action=getReservations");
        const data = await res.json();
        renderTable(data);
      } catch (err) {
        document.getElementById("reservation-list").innerHTML =
          "<tr><td colspan='10'>ã‚¨ãƒ©ãƒ¼: " + err + "</td></tr>";
      } finally { hideModal(); }
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderTable(data) {
      const storeFilter = document.getElementById("storeFilter").value;
      const startDateInput = document.getElementById("pickupStart").value;
      const endDateInput = document.getElementById("pickupEnd").value;
      const list = document.getElementById("reservation-list");
      list.innerHTML = "";

      let filtered = data.filter(r => !storeFilter || r.store === storeFilter);

      const today = new Date();
      const startOfWeek = new Date(today); startOfWeek.setDate(today.getDate() - today.getDay() + 1);
      const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      const endOfMonth = new Date(today.getFullYear(), today.getMonth()+1, 0);

      filtered = filtered.filter(r => {
        const created = new Date(r.createdAt);
        switch(currentPreset){
          case "tomorrow": const tomorrow = new Date(today); tomorrow.setDate(today.getDate()+1); return created.toDateString() === tomorrow.toDateString();
          case "today": return created.toDateString() === today.toDateString();
          case "week": return created >= startOfWeek && created <= today;
          case "month": return created >= startOfMonth && created <= endOfMonth;
          default: return true;
        }
      });

      // å—å–æ—¥ç¯„å›²
      if(startDateInput || endDateInput){
        const startDate = startDateInput ? new Date(startDateInput) : null;
        const endDate = endDateInput ? new Date(endDateInput) : null;
        filtered = filtered.filter(r => {
          const pickupDate = new Date(r.pickupDateFormatted);
          if(startDate && pickupDate < startDate) return false;
          if(endDate && pickupDate > endDate) return false;
          return true;
        });
      }

      // ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶è¡¨ç¤º
      const presetLabel = {"tomorrow":"æ˜æ—¥","today":"ä»Šæ—¥","week":"ä»Šé€±","month":"ä»Šæœˆ","all":"å…¨æœŸé–“"}[currentPreset];
      const storeLabel = storeFilter || "å…¨åº—èˆ—";
      const dateLabel = (startDateInput || endDateInput) ? `${startDateInput||"æŒ‡å®šãªã—"}ã€œ${endDateInput||"æŒ‡å®šãªã—"}` : "å…¨ã¦";
      document.getElementById("currentFilterInfo").innerHTML =
        `ğŸ” è¡¨ç¤ºæ¡ä»¶ï¼š<strong>${storeLabel}</strong>ï½œ<strong>${presetLabel}</strong>ï½œå—å–æ—¥ <strong>${dateLabel}</strong>`;

      filtered.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
      let totalSales = 0;

      if(filtered.length===0){
        list.innerHTML="<tr><td colspan='10'>è©²å½“ã™ã‚‹äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>";
        document.getElementById("salesSummary").textContent="å£²ä¸Šåˆè¨ˆ: 0å††";
        return;
      }

      filtered.forEach(r=>{
        totalSales+=Number(r.total);
        const tr = document.createElement("tr");
        tr.innerHTML=`
          <td>${r.id}</td>
          <td>${r.name}æ§˜</td>
          <td>${r.phone}</td>
          <td>${r.store}</td>
          <td>${r.pickupDateFormatted}</td>
          <td>${r.pickupTimeFormatted}</td>
          <td>${(r.products||"").replace(/\n/g,"<br>")}</td>
          <td>${Number(r.total).toLocaleString()}å††</td>
          <td>${r.memo||""}</td>
          <td>${r.createdAt}</td>
        `;
        list.appendChild(tr);
      });

      document.getElementById("salesSummary").textContent="å£²ä¸Šåˆè¨ˆ: "+totalSales.toLocaleString()+"å††";
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById("storeFilter").addEventListener("change",loadReservations);
    document.getElementById("applyDateRange").addEventListener("click",loadReservations);
    document.querySelectorAll(".preset-buttons button").forEach(btn=>{
      btn.addEventListener("click", e=>{
        document.querySelectorAll(".preset-buttons button").forEach(b=>b.classList.remove("active"));
        e.target.classList.add("active");
        currentPreset = e.target.dataset.preset;
        loadReservations();
      });
    });

    loadReservations();
  </script>
</body>
</html>
